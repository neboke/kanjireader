name: Build and Submit to TestFlight

permissions:
  contents: read

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã®ã¿

jobs:
  build-and-submit:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ðŸ“¦ Install EAS CLI
        run: npm install -g eas-cli

      - name: ðŸ”‘ Set Expo Access Token
        run: echo "EXPO_TOKEN=${{ secrets.EXPO_TOKEN }}" >> $GITHUB_ENV

      - name: ðŸ“š Install Dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build iOS App (EAS)
        run: eas build --platform ios --profile production --non-interactive

      - name: ðŸ” Get Latest Build Artifact URL
        id: get_url
        run: |
          echo "url=$(eas build:list --platform ios --status finished --limit 1 --json | jq -r '.[0].artifacts.buildUrl')" >> $GITHUB_OUTPUT
        env:
          EAS_ACCESS_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ§¾ Save App Store API Key (.p8)
        run: |
          echo "${{ secrets.ASC_API_KEY_BASE64 }}" | base64 --decode > authkey.p8

      - name: ðŸš€ Submit to TestFlight
        run: |
          eas submit --platform ios \
            --path ${{ steps.get_url.outputs.url }} \
            --non-interactive \
            --asc-api-key-path authkey.p8 \
            --asc-api-key-issuer-id ${{ secrets.ASC_API_KEY_ISSUER_ID }} \
            --asc-api-key-id ${{ secrets.ASC_API_KEY_ID }}
        env:
          EAS_ACCESS_TOKEN: ${{ secrets.EXPO_TOKEN }}

